{% extends 'base/base.html' %}
{% load fecha_filters %}

{% block title %}Estadísticas - Sistema de Eventos del Gobernador{% endblock %}

{% block extra_css %}
<style>
    .stats-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        margin-bottom: 2rem;
    }
    
    .stats-card {
        transition: transform 0.3s ease;
        border-radius: 15px;
        border: none;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    
    .chart-container {
        position: relative;
        height: 400px;
        margin: 20px 0;
    }
    
    .chart-container-large {
        position: relative;
        height: 600px;
        margin: 20px 0;
    }
    
    .chart-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .chart-header {
        background: #f8f9fa;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #dee2e6;
    }
    
    .metric-icon {
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }
    
    .metric-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .improvement-badge {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: bold;
        margin-top: 1rem;
        display: inline-block;
    }
</style>
{% endblock %}

{% block content %}


    <!-- Métricas principales -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stats-card bg-primary text-white h-100">
                <div class="card-body text-center">
                    <i class="fas fa-calendar-alt metric-icon"></i>
                    <div class="metric-number">{{ total_eventos }}</div>
                    <h6 class="card-title">Total de Eventos</h6>
                    <small>Eventos registrados en el sistema</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stats-card bg-success text-white h-100">
                <div class="card-body text-center">
                    <i class="fas fa-user-check metric-icon"></i>
                    <div class="metric-number">{{ eventos_gobernador }}</div>
                    <h6 class="card-title">Asistió Gobernador</h6>
                    <small>
                        {{ eventos_gobernador }} de {{ total_eventos }} eventos
                        {% if total_eventos > 0 %}
                            ({{ porcentaje_gobernador }}%)
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stats-card bg-warning text-dark h-100">
                <div class="card-body text-center">
                    <i class="fas fa-user-friends metric-icon"></i>
                    <div class="metric-number">{{ eventos_representante }}</div>
                    <h6 class="card-title">Asistió Representante</h6>
                    <small>
                        {{ eventos_representante }} de {{ total_eventos }} eventos
                        {% if total_eventos > 0 %}
                            ({{ porcentaje_representante }}%)
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stats-card bg-info text-white h-100">
                <div class="card-body text-center">
                    <i class="fas fa-star metric-icon"></i>
                    <div class="metric-number">{{ eventos_festivos }}</div>
                    <h6 class="card-title">Eventos Festivos</h6>
                    <small>
                        {{ eventos_festivos }} de {{ total_eventos }} eventos
                        {% if total_eventos > 0 %}
                            ({{ porcentaje_festivos }}%)
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficas principales -->
    <div class="row mb-4">
        <!-- Eventos por Municipio -->
        <div class="col-lg-6 mb-4">
            <div class="chart-card">
                <div class="chart-header">
                    <h5 class="mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        Top 10 Municipios con Más Eventos
                    </h5>
                </div>
                <div class="chart-container p-3">
                    <canvas id="municipiosChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Asistencia del Gobernador -->
        <div class="col-lg-6 mb-4">
            <div class="chart-card">
                <div class="chart-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user-check me-2"></i>
                        Asistencia del Gobernador vs Representante
                    </h5>
                </div>
                <div class="chart-container p-3">
                    <canvas id="asistenciaChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráfica principal mejorada -->
    <div class="row">
        <div class="col-12">
            <div class="chart-card">
                <div class="chart-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Análisis de Asistencia por Municipio (Top 20)
                        </h5>
                        <small class="text-muted">Comparación detallada de asistencia del Gobernador vs Representante por municipio</small>
                    </div>
                    <div class="improvement-badge">
                        <i class="fas fa-trophy me-1"></i>
                        Análisis Mejorado
                    </div>
                </div>
                <div class="chart-container-large p-4">
                    <canvas id="asistenciaMunicipioChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Datos desde Django
const municipiosData = {{ municipios_data|safe }};
const asistenciaData = {{ asistencia_data|safe }};

// Configuración de colores mejorada
const colors = {
    primary: '#667eea',
    success: '#28a745',
    warning: '#ffc107',
    info: '#17a2b8',
    danger: '#dc3545',
    purple: '#6f42c1',
    orange: '#fd7e14',
    teal: '#20c997',
    pink: '#e83e8c',
    gray: '#6c757d'
};

// Gráfica de Municipios (Doughnut)
const municipiosCtx = document.getElementById('municipiosChart').getContext('2d');
new Chart(municipiosCtx, {
    type: 'doughnut',
    data: {
        labels: municipiosData.labels,
        datasets: [{
            data: municipiosData.data,
            backgroundColor: [
                colors.primary, colors.success, colors.warning, colors.info, colors.danger,
                colors.purple, colors.orange, colors.teal, colors.pink, colors.gray
            ],
            borderWidth: 2,
            borderColor: '#fff',
            hoverBorderWidth: 3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true,
                    font: {
                        size: 12
                    }
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((value / total) * 100).toFixed(1);
                        return `${label}: ${value} eventos (${percentage}%)`;
                    }
                }
            }
        }
    }
});

// Gráfica de Asistencia (Pie)
const asistenciaCtx = document.getElementById('asistenciaChart').getContext('2d');
new Chart(asistenciaCtx, {
    type: 'pie',
    data: {
        labels: ['Asistió Gobernador', 'Asistió Representante'],
        datasets: [{
            data: [{{ eventos_gobernador }}, {{ eventos_representante }}],
            backgroundColor: [colors.success, colors.warning],
            borderWidth: 3,
            borderColor: '#fff',
            hoverBorderWidth: 4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true,
                    font: {
                        size: 14
                    }
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed;
                        const total = {{ total_eventos }};
                        const percentage = ((value / total) * 100).toFixed(1);
                        return `${label}: ${value} eventos (${percentage}%)`;
                    }
                }
            }
        }
    }
});

// MEJORADA: Gráfica de Asistencia por Municipio (Barras horizontales)
const asistenciaMunicipioCtx = document.getElementById('asistenciaMunicipioChart').getContext('2d');
new Chart(asistenciaMunicipioCtx, {
    type: 'bar',
    data: {
        labels: asistenciaData.labels,
        datasets: [
            {
                label: 'Asistió Gobernador',
                data: asistenciaData.gobernador,
                backgroundColor: colors.success,
                borderColor: colors.success,
                borderWidth: 1,
                borderRadius: 4,
                borderSkipped: false,
            },
            {
                label: 'Asistió Representante',
                data: asistenciaData.representante,
                backgroundColor: colors.warning,
                borderColor: colors.warning,
                borderWidth: 1,
                borderRadius: 4,
                borderSkipped: false,
            }
        ]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            intersect: false,
        },
        scales: {
            x: {
                stacked: true,
                beginAtZero: true,
                grid: {
                    color: '#e9ecef'
                },
                ticks: {
                    stepSize: 1,
                    font: {
                        size: 12
                    }
                }
            },
            y: {
                stacked: true,
                grid: {
                    display: false
                },
                ticks: {
                    font: {
                        size: 11
                    },
                    maxRotation: 0
                }
            }
        },
        plugins: {
            legend: {
                position: 'top',
                align: 'center',
                labels: {
                    usePointStyle: true,
                    padding: 20,
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                }
            },
            tooltip: {
                mode: 'index',
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: '#667eea',
                borderWidth: 1,
                callbacks: {
                    title: function(context) {
                        return `Municipio: ${context[0].label}`;
                    },
                    afterBody: function(context) {
                        const municipioIndex = context[0].dataIndex;
                        const total = asistenciaData.totales[municipioIndex];
                        return `Total eventos: ${total}`;
                    }
                }
            }
        },
        layout: {
            padding: {
                top: 20,
                right: 20,
                bottom: 20,
                left: 20
            }
        }
    }
});
</script>
{% endblock %}